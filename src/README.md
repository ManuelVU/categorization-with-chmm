# Source Code

Files in this section include functions to read and write data files (`~/data-f`), calculate similarities (`~/similarity-f`), sampling  (`~/sampling-f`), simulation (`~/simulation-f`), summaries (`~/summary-f`) and plotting (`~/plt-f`). Functions are used by files in the `~/analysis` directory.

----

### Data functions

The directory `~/data-f/` contains a function that reads and writes data from Lee and Navarro's 2002 experiment.  The raw data files are stored in `.mat` format at `~/data/matlab-files/`

  - `lee-navarro-rw.R` this function reads the raw data from Lee and Navarro's 2002 experiment and saves the output in long format as a `.csv` file into the `~data/csv-files/` directory.

----

### Similarity functions

The directory `~/similarity-f/` contains functions that can write stimulus-features data files in `.csv` format and functions to calculate the similarity between stimuli in the experiment. These functions are used by  the sampling methods in `~/sampling-f/`.

- `featural-distance.R` function that calculates the feature distance of a target stimulus **I** (rows) and a comparison stimulus **J** (columns). Function takes two arguments, a distinctive features array generated by the function in `lee-navarro-distinctive.R`, and a salience vector that indexes the weight of each feature dimension. This vector needs to have as many elements as the number of stimulus features on a given stimulus set. The output is a symmetric dissimilarity matrix. This measure is based on Lee and Navarro's (2002) equation 12.
- `lee-navarro-distinctive.R` function that takes a stimulus feature matrix and returns a three-dimensional array with the features in stimulus **I** that are not shared by **J** and the features in stimulus **J** not shared by **I** for all stimuli in the experiment. Stimulus **I** is considered the target and **J** is the comparison stimulus. Function returns a list with two three-dimensional arrays `i_not_in_j` and `not_in_i_in_j`. The third dimension indexes the target stimulus **I**. Rows index the comparison stimulus **J** and columns the feature according to the order of the `stimulus` variable in the stimulus feature matrix provided as an argument to the function.
- `lee-navarro-features.R` function that writes a data-frame in a `.csv` format with the stimulus, stimulus name, and features (presence/absence) from Lee and Navarro's 2002 experiment.
- `similarity.R` function calculates the similarity between stimulus **I** and **J** for a given decay_rate and decay_function. These parameters represent the speed and the shape of the function of the decay in similarity as a function of distance. This function takes 3 arguments, a scalar decay_rate, a decay_function value and a symmetric distance matrix. 

----

### Sampling functions

The directory `~/sampling-f/` contains functions used by the sampling methods that are specific to CHMM process. Functions are called in by the code used for data analysis in the `~/analysis/` directory.

  - `adjust-stepsize.R` function that adjusts the step-size used for HMC. This function is used by the `chmm-sampler` during the burn-in period if it contains at least 100 samples. The function takes as arguments the previous step-size (`stepsize`), the current acceptance probability (`acceptance_prob`), and the target acceptance probability of the algorithm (`target_acceptance`). The function returns a single value for the next step-size.
  - `chmm-sampler.R` function that returns a list containing the posterior samples after a specified burn-in period of the the parameters of the CHMM model. The function returns a list that contains the posterior samples, the acceptance probability and the step size used by the HMC algorithm for each participant. The function takes as arguments the data from an experiment in a chmm format (`data_chmm`), a metric (`metric`), an order for the metric (`order_p`), a number of iterations (`n_iterations`), a number of samples to discard (`n_burn`), the number of cores to be used for parallel computing (`n_cores`), a list with the initial values of the parameters in the model (`parameters_initial_values`), a starting step size for the HMC algorithm (`start_step_size`), an acceptance probability for the HMC algorithm (`hmc_acceptance`) and a list with the prior values for the distributions of the parameters in the model.
  - `epsilon-update.R` sample of the conditional posterior distribution of the trembling-hand parameter by participant. The function returns a *p-dimensional* vector of samples where $p$ represents the number of participants in the study. This function takes as arguments the current states sample of all participants (`states_all`), participants responses to all stimulus in the study across trials (`responses_all`) and the value of the parameters of the beta prior distribution assigned to the trembling-hand parameter $\epsilon$. 
  - `ffbs.R` forward filter backward sample algorithm. The function returns a list with a sample of the conditional posterior distribution of the unobserved states and the summed log-likelihood for the sequence. The function takes as arguments a stimulus id (`update_stimulus_id`), a set of unobserved states (`unobserved_states`) and a vector of responses (`responses`) and calculates the conditional filtered probabilities used in by the backward sample algorithm to generate a posterior sample of the states associated with the stimulus being updated. The function also requires the following data: a symmetric similarity matrix (`similarity`), the number of possible states a chain can take (`n_states`), a value for the trembling-hand parameter (`response_error`), a value of the initial state probability distribution of size equal to the number of states minus one (`initial_probability`), a stickiness parameter in favor of category A (`inertia_category_a`) and one for category B (`inertia_category_b`). 
  - `gamma-update.R` single sample of the posterior distribution of the initial state probability parameter $\gamma$. The function returns a single sample of the conditional posterior distribution of the initial probability parameter $\gamma$ for each participant as a *p-dimensional* vector. The function takes as arguments a matrix of initial states of all stimulus as rows and participants as columns (`initial_states`), and a two dimensional vector with the parameters of the prior distribution of the parameter `gamma_prior`. 
  - `gradient-inertia.R` partial derivative of the full joint posterior distribution of the logarithm of the stickiness parameters in the categorization model ($\tilde{\alpha} = ln(\alpha)$ and $\tilde{\beta} = ln(\beta)$). The function returns a vector with the value of the partial derivative of the full joint conditional posterior distribution of $\tilde{\alpha}$ and $\tilde{\beta}$ as a two dimensional vector in the order ($\tilde{\alpha}$, $\tilde{\beta}$). The function takes as arguments the current sample of the hidden states for a given participant **p** $X_{t=1}^{[1:C,\ p]}$ (`states`), a value of the logarithm of the stickiness parameters (`alpha_tilde` and `beta_tilde`), two vectors with the value of the parameters of the gamma prior distribution of the parameters (`alpha_prior` and `beta_prior`), a between stimulus similarity matrix (`similarity`), the total number of trials for the participant (`total_trials`) and the total number of stimulus (`n_stimulus`). This function is used exclusively by `hamiltoninan-mc.R`.
  - `hamiltonian-mc.R` Hamiltonian Monte Carlo algorithm. The function returns two elements on a list, first is a vector with the sampled values of $\tilde{alpha}$ and $\tilde{\beta}$ respectively, and a value of the potential energy of the sample to be used in the next iteration of the algorithm. The function takes nine arguments, the current sample of the states (`states`), the values of the logarithm of the stickiness parameters (`alpha_tilde` and `beta_tilde`), two vectors with the values of the parameters of the prior distribution of the stickiness parameters $\alpha$ and $\beta$ (`alpha_prior` and `beta_prior`), a between stimulus similarity matrix (`similarity`), a step size for the Hamiltonian dynamics (`epsilon`) a number of leaps used by the leapfrog part of the algorithm and the potential energy of the current value of the parameters (`potential_current`).
  - `log-posterior.R` calculates the logarithm of the full joint conditional posterior distribution of the logarithm of the stickiness parameters in the CHMM model ($\tilde{\alpha} = ln(\alpha)$ and $\tilde{\beta} = ln(\beta)$). The function returns a single value with the evaluation of the logarithm of the full joint conditional posterior distribution of the parameters $\tilde{\alpha}$ and $\tilde{\beta}$ evaluated at the values `alpha_tilde` and `beta_tilde`. The function takes as arguments the current sample of the hidden states for a fixed participant **p** $X_{t=1:T}^{[1:C,\ p]}$ (`states`), a value of the logarithm  of the stickiness parameters (`alpha_tilde` and `beta_tilde`), two vectors with the value of the parameters of the gamma prior distribution of the inertia parameters (`alpha_prior` and `beta_prior`), a between stimuli similarity matrix (`similarity`), the total number of trials (`total_trials`) and the total number of stimulus (`n_stimulus`).  This function is used exclusively by `hamiltoninan-mc.R`.
  - `logit.R` function that takes a value `x` and returns the logit of $x$, defined as: $$\frac{1}{1+e^{-x}}.$$
  - `participant-chains-update.R` function applies the forward filter backward sample algorithm to all stimuli for a single participant. This function returns a sample of the hidden states of all stimuli at every trial in matrix form. This function takes as arguments the current sample of the hidden states (`states_current`), the participant's responses (`responses`) as a matrix (NA if the stimulus was not presented), a between stimuli symmetric similarity matrix (`similarity`), the number of states in the model (`n_states`), the total number of trials (`total_trials`), the total number of stimuli (`total_chains`), the current value of the trembling hand parameter $\epsilon$ (`epsilon`), the current value of the initial probability parameter $\gamma$ (`gamma`), the current value of the stickiness parameter for category 0 $\alpha$ (`alpha`) and the current value of the stickiness parameter for category 1 $\beta$ (`beta`). This function is used by the sampler to parallelize some of the sampling process.
  - `posterior-adequacy-sampler.R` function that samples from the posterior predictive distribution of a fixed participant given the design of the experiment. The function returns a matrix where the rows index the iteration number and the columns index the trial number. This function takes as arguments the number of posterior samples to take (`iterations`), the posterior samples of the parameters in the model (`posterior`), the stimulus id for each trial (`stimulus_id`), the id of participant p as organized in the posterior samples (`participant_id`) and the total number of trials of the participant (`total_trials`).
  - `sample-prior-states.R` function that generates initial values for the 
      hidden states of the CHMM. The function takes the following arguments: the 
        number of chains or stimulus (`n_chains`), the number of trials per 
        participant (`n_trials`), the number of participants (`n_participants`), 
        the similarity between stimulus (`similarity`), the initial probability 
        distribution over possible states (`initial_state_probability`), the inertia
        parameter in favor of category a and b (`inertia_category_a`, 
        `inertia_category_b`) respectively. The output of the function is an array 
        of size equal to the number of stimulus times the maximum number of trials 
        times the number of participants.
  - `transform-data-chmm.R` function that takes a directory to the experimental 
      data and the stimulus features and returns a list that contains the responses 
        by trial by participant in the experiment, the number of trials each 
        participant responded to and the features of the stimulus used in the 
        experiment. The output can be passed directly to the function in 
        `chmm-sampler.R` to start the analysis. 
  - `transition_others.R` function that computes the product of the transition
      probabilities of all other chains except the one currently being updated. The
        function takes 6 arguments: the states of all other chains except the one 
        being updated at the current trial (`state_now`) and the next trial 
        (`state_after`), a symmetric similarity matrix (`similarity`), the id of the 
        stimulus that is currently being updated (`current_id`), an inertia parameter 
        in favor of category A (`alpha`) and an inertia parameter in favor of category 
        B (`beta`).

